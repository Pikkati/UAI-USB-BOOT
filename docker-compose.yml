version: '3.8'

#==============================================================================
# UAI Platform Docker Compose Configuration
# Complete platform stack with monitoring, storage, and orchestration
#==============================================================================

services:
  # ============================================================================
  # Core UAI Platform Services
  # ============================================================================

  uai-api:
    image: uai-platform:latest
    container_name: uai-api
    ports:
      - "8000:8000"
    environment:
      - UAI_ENV=production
      - DOCKER_SWARM=true
      - REDIS_URL=redis://redis-cluster:6379
      - CONSUL_URL=http://consul:8500
    volumes:
      - uai-data:/app/data
      - uai-config:/app/config
      - uai-logs:/app/logs
    networks:
      - uai-platform
      - uai-monitoring
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.uai-api.rule=Host(`uai-platform.local`) || PathPrefix(`/api`)"
        - "traefik.http.routers.uai-api.service=uai-api"
        - "traefik.http.services.uai-api.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - redis-cluster
      - consul

  uai-worker:
    image: uai-platform:latest
    environment:
      - UAI_ENV=production
      - DOCKER_SWARM=true
      - WORKER_MODE=true
      - REDIS_URL=redis://redis-cluster:6379
      - CONSUL_URL=http://consul:8500
    volumes:
      - uai-data:/app/data
      - uai-config:/app/config
      - uai-logs:/app/logs
    networks:
      - uai-platform
      - uai-monitoring
    deploy:
      mode: replicated
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - redis-cluster
      - consul

  # ============================================================================
  # Infrastructure Services
  # ============================================================================

  consul:
    image: consul:latest
    container_name: consul
    ports:
      - "8500:8500"  # HTTP API
      - "8600:8600"  # DNS
      - "8502:8502"  # gRPC
    environment:
      - CONSUL_BIND_INTERFACE=eth0
      - CONSUL_CLIENT_INTERFACE=eth0
    volumes:
      - consul-config:/consul/config
      - consul-data:/consul/data
    networks:
      - uai-platform
    command: agent -server -bootstrap -ui -client=0.0.0.0
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/v1/status/leader"]
      interval: 30s
      timeout: 10s
      retries: 3

  traefik:
    image: traefik:latest
    container_name: traefik
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
      - "8080:8080"  # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-config:/etc/traefik
      - traefik-letsencrypt:/letsencrypt
    networks:
      - uai-platform
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=admin@uai-platform.local"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.uai-platform.local`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$2y$$10$$..."

  redis-cluster:
    image: redis:latest
    container_name: redis-cluster
    ports:
      - "6379:6379"    # Redis port
      - "16379:16379"  # Cluster bus port
    volumes:
      - redis-config:/etc/redis
      - redis-data:/data
    networks:
      - uai-platform
    command: redis-server /etc/redis/redis.conf
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Monitoring Stack
  # ============================================================================

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - prometheus-config:/etc/prometheus
      - prometheus-data:/prometheus
    networks:
      - uai-monitoring
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.uai-platform.local`)"
      - "traefik.http.routers.prometheus.service=prometheus"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=uai2024!
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-worldmap-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - grafana-config:/etc/grafana
      - grafana-dashboards:/var/lib/grafana/dashboards
    networks:
      - uai-monitoring
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.uai-platform.local`)"
      - "traefik.http.routers.grafana.service=grafana"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  node-exporter:
    image: quay.io/prometheus/node-exporter:latest
    container_name: node-exporter
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - uai-monitoring
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    deploy:
      mode: global
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9100/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    ports:
      - "8081:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker:/var/lib/docker:ro
      - /dev/disk:/dev/disk:ro
    networks:
      - uai-monitoring
    privileged: true
    devices:
      - /dev/kmsg
    deploy:
      mode: global
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Storage Services
  # ============================================================================

  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"      # API
      - "9001:9001"      # Console
    environment:
      - MINIO_ACCESS_KEY=uaiaccesskey
      - MINIO_SECRET_KEY=uaisecretkey2024
      - MINIO_REGION=us-east-1
    volumes:
      - minio-data:/data
    networks:
      - uai-storage
    command: server /data --console-address ":9001"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio.rule=Host(`minio.uai-platform.local`)"
      - "traefik.http.routers.minio.service=minio"
      - "traefik.http.services.minio.loadbalancer.server.port=9001"

  postgres:
    image: postgres:15-alpine
    container_name: postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=uai_platform
      - POSTGRES_USER=uai
      - POSTGRES_PASSWORD=uai2024!
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - postgres-config:/etc/postgresql
    networks:
      - uai-platform
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U uai -d uai_platform"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Logging and Observability
  # ============================================================================

  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "3100:3100"
    volumes:
      - loki-config:/etc/loki
      - loki-data:/loki
    networks:
      - uai-monitoring
    command: -config.file=/etc/loki/local-config.yaml
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3

  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    volumes:
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - promtail-config:/etc/promtail
    networks:
      - uai-monitoring
    command: -config.file=/etc/promtail/config.yml
    deploy:
      mode: global
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '0.2'
          memory: 128M

# ============================================================================
# Networks
# ============================================================================

networks:
  uai-platform:
    driver: overlay
    attachable: true
    labels:
      - "uai.network.type=platform"

  uai-monitoring:
    driver: overlay
    attachable: true
    labels:
      - "uai.network.type=monitoring"

  uai-storage:
    driver: overlay
    attachable: true
    labels:
      - "uai.network.type=storage"

# ============================================================================
# Volumes
# ============================================================================

volumes:
  # Application data
  uai-data:
    driver: local
    labels:
      - "uai.volume.type=data"

  uai-config:
    driver: local
    labels:
      - "uai.volume.type=config"

  uai-logs:
    driver: local
    labels:
      - "uai.volume.type=logs"

  # Infrastructure data
  consul-data:
    driver: local
    labels:
      - "uai.volume.type=consul"

  consul-config:
    driver: local
    labels:
      - "uai.volume.type=consul-config"

  redis-data:
    driver: local
    labels:
      - "uai.volume.type=redis"

  redis-config:
    driver: local
    labels:
      - "uai.volume.type=redis-config"

  traefik-config:
    driver: local
    labels:
      - "uai.volume.type=traefik"

  traefik-letsencrypt:
    driver: local
    labels:
      - "uai.volume.type=traefik-ssl"

  # Monitoring data
  prometheus-data:
    driver: local
    labels:
      - "uai.volume.type=prometheus"

  prometheus-config:
    driver: local
    labels:
      - "uai.volume.type=prometheus-config"

  grafana-data:
    driver: local
    labels:
      - "uai.volume.type=grafana"

  grafana-config:
    driver: local
    labels:
      - "uai.volume.type=grafana-config"

  grafana-dashboards:
    driver: local
    labels:
      - "uai.volume.type=grafana-dashboards"

  # Storage data
  minio-data:
    driver: local
    labels:
      - "uai.volume.type=minio"

  postgres-data:
    driver: local
    labels:
      - "uai.volume.type=postgres"

  postgres-config:
    driver: local
    labels:
      - "uai.volume.type=postgres-config"

  # Logging data
  loki-data:
    driver: local
    labels:
      - "uai.volume.type=loki"

  loki-config:
    driver: local
    labels:
      - "uai.volume.type=loki-config"

  promtail-config:
    driver: local
    labels:
      - "uai.volume.type=promtail"