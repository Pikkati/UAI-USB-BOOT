name: Validate optional OpenTelemetry (project image build)

on:
  schedule:
    - cron: '0 5 * * 1' # weekly, Monday at 05:00 UTC
  workflow_dispatch:
  pull_request:
    branches: [ main, develop ]

jobs:
  project-image-build:
    runs-on: [self-hosted, docker-swarm]
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Set up Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build project image with INSTALL_OTEL (SKIP_HEAVY=1)
        run: |
          docker buildx build --progress=plain \
            --build-arg SKIP_HEAVY=1 \
            --build-arg INSTALL_OTEL=1 \
            --cache-from type=registry,ref=ghcr.io/${{ github.repository }}:buildcache \
            --cache-to type=registry,ref=ghcr.io/${{ github.repository }}:buildcache,mode=max \
            -t uai-project-otel:ci .
      - name: Verify import inside project image
        run: |
          docker run --rm uai-project-otel:ci python - <<'PY'
          import importlib.metadata as m
          import opentelemetry
          print('project image import OK')
          try:
              print('opentelemetry-api', m.version('opentelemetry-api'))
          except Exception:
              pass
          PY
      - name: Clean up
        run: docker rmi uai-project-otel:ci || true
