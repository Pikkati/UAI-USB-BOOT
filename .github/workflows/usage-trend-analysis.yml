name: GitHub Actions Usage Trend Analysis

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:

jobs:
  analyze_trends:
    runs-on: [self-hosted, docker-swarm]
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          ref: metrics
          fetch-depth: 0

      - name: Analyze Usage Trends
        id: analysis
        run: |
          echo "📊 Analyzing GitHub Actions usage trends..."

          # Get all metrics files from the last 7 days
          find metrics -name "usage-*.json" -mtime -7 | sort > recent_files.txt

          if [ ! -s recent_files.txt ]; then
            echo "No recent metrics found - analysis requires at least 24 hours of data"
            echo "trend_direction=insufficient_data" >> $GITHUB_OUTPUT
            echo "prediction_days=0" >> $GITHUB_OUTPUT
            echo "recommendations=Collect more data for trend analysis" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract usage data
          echo "timestamp,used_minutes,remaining_minutes,percentage_used" > usage_data.csv
          cat recent_files.txt | while read file; do
            timestamp=$(jq -r '.timestamp' "$file" 2>/dev/null || echo "")
            used=$(jq -r '.used_minutes' "$file" 2>/dev/null || echo "0")
            remaining=$(jq -r '.remaining_minutes' "$file" 2>/dev/null || echo "0")
            percentage=$(jq -r '.percentage_used' "$file" 2>/dev/null || echo "0")

            if [ -n "$timestamp" ]; then
              echo "$timestamp,$used,$remaining,$percentage" >> usage_data.csv
            fi
          done

          # Calculate trend statistics
          TOTAL_POINTS=$(wc -l < usage_data.csv)
          TOTAL_POINTS=$((TOTAL_POINTS - 1))  # Subtract header

          if [ $TOTAL_POINTS -lt 2 ]; then
            echo "trend_direction=insufficient_data" >> $GITHUB_OUTPUT
            echo "prediction_days=0" >> $GITHUB_OUTPUT
            echo "recommendations=Need more data points for analysis" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get first and last data points
          FIRST_LINE=$(tail -n +2 usage_data.csv | head -1)
          LAST_LINE=$(tail -n +2 usage_data.csv | tail -1)

          FIRST_USED=$(echo $FIRST_LINE | cut -d',' -f2)
          LAST_USED=$(echo $LAST_LINE | cut -d',' -f2)
          FIRST_TIME=$(echo $FIRST_LINE | cut -d',' -f1 | xargs date -d 2>/dev/null || echo "0")
          LAST_TIME=$(echo $LAST_LINE | cut -d',' -f1 | xargs date -d 2>/dev/null || echo "0")

          # Calculate usage rate (minutes per day)
          if [ "$FIRST_TIME" != "0" ] && [ "$LAST_TIME" != "0" ]; then
            DAYS_DIFF=$(( ($(date -d "$LAST_TIME" +%s) - $(date -d "$FIRST_TIME" +%s)) / 86400 ))
            if [ $DAYS_DIFF -gt 0 ]; then
              USED_DIFF=$((LAST_USED - FIRST_USED))
              DAILY_RATE=$((USED_DIFF / DAYS_DIFF))
            else
              DAILY_RATE=0
            fi
          else
            DAILY_RATE=0
          fi

          # Get current remaining minutes (from last data point)
          CURRENT_REMAINING=$(echo $LAST_LINE | cut -d',' -f3)
          CURRENT_PERCENTAGE=$(echo $LAST_LINE | cut -d',' -f4)

          # Predict days remaining
          if [ $DAILY_RATE -gt 0 ]; then
            PREDICTION_DAYS=$((CURRENT_REMAINING / DAILY_RATE))
          else
            PREDICTION_DAYS=999
          fi

          # Determine trend direction
          if [ $DAILY_RATE -gt 500 ]; then
            TREND="rapidly_increasing"
            TREND_EMOJI="📈"
          elif [ $DAILY_RATE -gt 200 ]; then
            TREND="increasing"
            TREND_EMOJI="📊"
          elif [ $DAILY_RATE -gt 0 ]; then
            TREND="slowly_increasing"
            TREND_EMOJI="📉"
          elif [ $DAILY_RATE -eq 0 ]; then
            TREND="stable"
            TREND_EMOJI="➡️"
          else
            TREND="decreasing"
            TREND_EMOJI="📉"
          fi

          # Generate recommendations
          RECOMMENDATIONS=""
          if [ $PREDICTION_DAYS -lt 7 ]; then
            RECOMMENDATIONS="⚠️ Critical: Less than 7 days remaining at current usage rate. Consider immediate action."
          elif [ $PREDICTION_DAYS -lt 14 ]; then
            RECOMMENDATIONS="🟡 Warning: Less than 14 days remaining. Monitor closely and optimize workflows."
          elif [ $PREDICTION_DAYS -lt 30 ]; then
            RECOMMENDATIONS="ℹ️ Info: Less than 30 days remaining. Consider usage optimization."
          else
            RECOMMENDATIONS="✅ Good: More than 30 days remaining at current usage rate."
          fi

          if [ "$TREND" = "rapidly_increasing" ]; then
            RECOMMENDATIONS="$RECOMMENDATIONS Identify and optimize high-usage workflows."
          fi

          # Output results
          echo "trend_direction=$TREND" >> $GITHUB_OUTPUT
          echo "trend_emoji=$TREND_EMOJI" >> $GITHUB_OUTPUT
          echo "daily_rate=$DAILY_RATE" >> $GITHUB_OUTPUT
          echo "prediction_days=$PREDICTION_DAYS" >> $GITHUB_OUTPUT
          echo "current_remaining=$CURRENT_REMAINING" >> $GITHUB_OUTPUT
          echo "current_percentage=$CURRENT_PERCENTAGE" >> $GITHUB_OUTPUT
          echo "recommendations=$RECOMMENDATIONS" >> $GITHUB_OUTPUT

          # Save analysis results
          mkdir -p analysis
          cat > analysis/trend-analysis-$(date +%Y-%m-%d).json << EOF
          {
            "analysis_date": "$(date -Iseconds)",
            "data_points": $TOTAL_POINTS,
            "trend_direction": "$TREND",
            "daily_usage_rate": $DAILY_RATE,
            "predicted_days_remaining": $PREDICTION_DAYS,
            "current_remaining_minutes": $CURRENT_REMAINING,
            "current_usage_percentage": $CURRENT_PERCENTAGE,
            "recommendations": "$RECOMMENDATIONS",
            "analysis_period_days": $DAYS_DIFF
          }
          EOF

      - name: Commit Analysis Results
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          if git diff --quiet analysis/; then
            echo "No analysis changes to commit"
          else
            git add analysis/
            git commit -m "📊 Usage trend analysis - $(date)" || true
            git push origin HEAD:metrics 2>/dev/null || true
          fi

      - name: Send Trend Alert
        if: ${{ steps.analysis.outputs.prediction_days != '' && fromJSON(steps.analysis.outputs.prediction_days) < 14 }}
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            TREND="${{ steps.analysis.outputs.trend_emoji }} ${{ steps.analysis.outputs.trend_direction }}"
            DAYS="${{ steps.analysis.outputs.prediction_days }}"
            RATE="${{ steps.analysis.outputs.daily_rate }}"

            PAYLOAD=$(cat <<EOF
            {
              "attachments": [
                {
                  "color": "warning",
                  "title": "GitHub Actions Usage Trend Alert",
                  "text": "Trend Analysis: $TREND\\nPredicted days remaining: $DAYS\\nDaily usage rate: $RATE minutes",
                  "fields": [
                    {
                      "title": "View Dashboard",
                      "value": "https://yushchyr.github.io/UAI_Copilot_Automation_Tool/dashboard/",
                      "short": true
                    }
                  ],
                  "footer": "Usage Trend Analysis",
                  "ts": $(date +%s)
                }
              ]
            }
          EOF
          )

            curl -X POST -H 'Content-type: application/json' \
              --data "$PAYLOAD" \
              "${{ secrets.SLACK_WEBHOOK_URL }}" || echo "Trend alert failed"
          fi

      - name: Generate Trend Report
        run: |
          echo "## 📊 GitHub Actions Usage Trend Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Trend Direction | ${{ steps.analysis.outputs.trend_emoji }} ${{ steps.analysis.outputs.trend_direction }} | $([ "${{ steps.analysis.outputs.trend_direction }}" = "rapidly_increasing" ] && echo '⚠️' || echo '✅') |" >> $GITHUB_STEP_SUMMARY
          echo "| Daily Usage Rate | ${{ steps.analysis.outputs.daily_rate }} minutes | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Predicted Days Left | ${{ steps.analysis.outputs.prediction_days }} | $([ ${{ steps.analysis.outputs.prediction_days }} -lt 14 ] && echo '🔴 CRITICAL' || [ ${{ steps.analysis.outputs.prediction_days }} -lt 30 ] && echo '🟡 WARNING' || echo '✅ GOOD') |" >> $GITHUB_STEP_SUMMARY
          echo "| Current Remaining | ${{ steps.analysis.outputs.current_remaining }} minutes | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Recommendations:" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.analysis.outputs.recommendations }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Analysis based on last 7 days of data*" >> $GITHUB_STEP_SUMMARY
          echo "*Dashboard: https://yushchyr.github.io/UAI_Copilot_Automation_Tool/dashboard/*" >> $GITHUB_STEP_SUMMARY
