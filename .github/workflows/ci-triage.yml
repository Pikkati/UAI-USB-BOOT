name: Triage Script Smoke Test
true:
  pull_request:
    branches:
    - main
  push:
    branches:
    - main
  workflow_dispatch: null
jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 10
      threshold_percent: 3
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
      slack_webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
  triage-test:
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    - name: Verify Runner Environment
      if: ${{ needs.credit_check.outputs.run_on_swarm == 'true' }}
      run: |
        echo "🏥 Verifying swarm runner environment..."

        # Check tools
        for tool in docker git python3 gh; do
          if ! command -v "$tool" &> /dev/null; then
            echo "❌ Missing tool: $tool"
            exit 1
          fi
        done

        # Check resources
        DISK=$(df / | awk 'NR==2 {print $4}')
        MEMORY=$(free -m | awk '/^Mem/ {print $7}')

        echo "✅ Disk: $(numfmt --to=iec $DISK 2>/dev/null || echo ${DISK}K) available"
        echo "✅ Memory: ${MEMORY}M available"
        echo "✅ Runner environment verified"
    - name: Check PowerShell availability
      shell: pwsh -NoProfile -Command {0}
      run: 'Write-Host "PowerShell version: $($PSVersionTable.PSVersion)"

        '
    - name: Run cascade triage against stable endpoint
      shell: pwsh -NoProfile -Command {0}
      run: '# Run triage script against httpbin stable endpoint

        Write-Host "Running cascade triage against https://httpbin.org/status/200"

        ./ops/triage/cascade_triage.ps1 -Endpoints @(''https://httpbin.org/status/200'')
        -OutputDir ''./triage-test-output'' -PrometheusUrl ''''

        '
    - name: List triage output
      if: always()
      run: 'ls -la triage-test-output || true

        echo ''If the triage script failed, check the job logs for details.'''
    needs:
    - credit_check
