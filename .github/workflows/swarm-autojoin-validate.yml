name: swarm-autojoin Validate
# CI DIAGNOSTIC RUN

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 10
      threshold_percent: 3
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
  test:
    needs: [credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    strategy:
      matrix:
        python-version: [ '3.11', '3.13' ]
    container:
      image: python:${{ matrix.python-version }}-slim

    steps:
      - name: Prepare container
        run: |
          apt-get update
          apt-get install -y git build-essential

      - name: Checkout (manual)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eux
          cd "$GITHUB_WORKSPACE"
          git init .
          # Git may refuse to operate inside directories it deems to have dubious ownership
          # (git >=2.35). When running inside a container the workspace directory ownership
          # can differ from the runner user. Mark the workspace as safe so manual checkout
          # commands succeed under the container environment.
          git config --global --add safe.directory "$GITHUB_WORKSPACE" || true
          git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          git fetch --depth=1 origin ${{ github.sha }} || git fetch --depth=1 origin +refs/heads/*:refs/remotes/origin/*
          git checkout -f ${{ github.sha }} || git checkout -f FETCH_HEAD || true

      - name: Install package and test deps
        run: |
          cd "$GITHUB_WORKSPACE"
          python -m pip install --upgrade pip
          python -m pip install -e .
          python -m pip install -r swarm_autojoin/requirements.txt
          python -m pip install pytest pytest-cov pytest-benchmark pytest-timeout

      - name: 'Diagnostic: verify pytest-cov installation'
        run: |
          python -V
          echo "--- pip show pytest-cov ---"
          python -m pip show pytest-cov || echo "pytest-cov not found"
          echo "--- pip list (top 200 lines) ---"
          python -m pip list | sed -n '1,200p'
          echo "--- try importing pytest and pytest_cov (non-fatal) ---"
          python - <<'PY2'
          import sys, importlib, traceback
          try:
              print('pytest version:', importlib.import_module('pytest').__version__)
          except Exception as e:
              print('pytest import failed:', type(e).__name__, e)
          try:
              pc = importlib.import_module('pytest_cov')
              print('pytest_cov module file:', getattr(pc, '__file__', 'no __file__'))
              print('pytest_cov version:', getattr(pc, '__version__', 'unknown'))
          except Exception as e:
              print('pytest_cov import failed:', type(e).__name__, e)
              traceback.print_exc()
          PY2

      - name: Run package tests
        run: python -m pytest -q swarm_autojoin -q

      - name: CLI smoke tests
        run: |
          mkdir -p ./network_shared
          swarm-auto-join --help
          swarm-auto-join --force-init --shared-dir ./network_shared --debug
