name: SSH Key Server Smoke Test

on:
  pull_request:
    paths:
      - 'triage/**'
      - 'deploy/ssh-key-server/**'

jobs:
  smoke:
    name: Run SSH Key Server smoke test
    runs-on: [self-hosted, docker-swarm]
    timeout-minutes: 10

    steps:
      - name: Check out repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Python 3.11
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
        with:
          python-version: '3.11'

      - name: Run broadcast functional test
        env:
          ENABLE_BROADCAST: '1'
          SSH_KEY_SERVER_HOST: '127.0.0.1'
          SSH_KEY_SERVER_PORT: '8889'
          BROADCAST_ADDR: '127.0.0.1'
          BROADCAST_PORT: '9999'
          BROADCAST_INTERVAL: '1'
        run: |
          python triage/tests/test_ssh_key_server_broadcast.py
