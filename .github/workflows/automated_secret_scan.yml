name: Automated Secret Vault Scan

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}
  schedule:
    - cron: '0 3 * * *' # daily at 03:00 UTC

permissions:
  actions: read
  contents: read
  issues: write

jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 10
      threshold_percent: 5
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
  scan:
    needs: [credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      SET_GITHUB_SECRET_REPO: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Python
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Run secret scan
        id: run_scan
        run: |
          python scripts/list_github_secrets.py --repo ${{ github.repository }} --verbose > secrets_report.txt
          echo "::set-output name=report::$(sed -n '1,200p' secrets_report.txt | sed 's/%/%25/g; s/\r//g; s/\n/%0A/g')"

      - name: Upload secret scan report artifact
        uses: actions/upload-artifact@ff15f0306b3f739f7b6fd43fb5d26cd321bd4de5
        with:
          name: secret-scan-report
          path: secrets_report.txt

      - name: Create or update "Automated Secret Scan Results" issue
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410
        with:
          script: |
            const fs = require('fs');
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            const title = 'Automated Secret Scan Results';
            const report = fs.existsSync('secrets_report.txt') ? fs.readFileSync('secrets_report.txt','utf8') : 'No report generated.';
            const body = 'Automated repository secret scan results (names, visibility, timestamps):\n\n' + '```\n' + report + '\n```\n\n_Last updated: ' + (new Date()).toISOString();
            // Find existing open issue with that title
            const issues = await github.rest.issues.listForRepo({ owner, repo, state: 'open', per_page: 100 });
            let issue = issues.data.find(i => i.title === title);
            if (issue) {
              await github.rest.issues.update({ owner, repo, issue_number: issue.number, body });
              core.info('Updated existing issue #' + issue.number);
            } else {
              const res = await github.rest.issues.create({ owner, repo, title, body });
              core.info('Created issue ' + res.data.html_url);
            }
