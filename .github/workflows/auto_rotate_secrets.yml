name: Auto Secret Rotation

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}
  schedule:
    - cron: '0 4 * * *' # daily at 04:00 UTC

permissions:
  contents: read
  issues: write
  secrets: write

jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 10
      threshold_percent: 5
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
  rotate-secret:
    needs: [credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    concurrency:
      group: rotate-secret-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Python
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Generate strong password
        id: gen_pw
        run: |
          pw=$(python - <<'PY'
          import secrets, string
          alphabet = string.ascii_letters + string.digits + "!@#$%&*()-_=+"
          print(''.join(secrets.choice(alphabet) for _ in range(32)))
          PY
          )
          echo "pw=$pw" >> $GITHUB_OUTPUT

      - name: Rotate GitHub Secret
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SECRET_NAME: SSH_GATEWAY_ROOT_PASSWORD
          SECRET_VALUE: ${{ steps.gen_pw.outputs.pw }}
        run: |
          python scripts/rotate_github_secret.py --repo ${{ github.repository }}

      - name: Notify rotation via issue
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = 'Automated Secret Rotation';
            const body = `Secret 'SSH_GATEWAY_ROOT_PASSWORD' was rotated by workflow run at ${new Date().toISOString()}.

            Do not commit secret values to issues or logs.`;
            const issues = await github.rest.issues.listForRepo({ owner, repo, state: 'open', per_page: 100 });
            let issue = issues.data.find(i => i.title === title);
            if (issue) {
              await github.rest.issues.createComment({ owner, repo, issue_number: issue.number, body: body });
            } else {
              await github.rest.issues.create({ owner, repo, title, body });
            }

      - name: Sync extension (if PAT provided)
        if: ${{ secrets.EXTENSION_PAT != '' }}
        env:
          EXTENSION_PAT: ${{ secrets.EXTENSION_PAT }}
          EXTENSION_REPO: ${{ secrets.EXTENSION_REPO }}
        run: |
          python scripts/sync_extension.py --repo "$EXTENSION_REPO" --pat "$EXTENSION_PAT" || true
