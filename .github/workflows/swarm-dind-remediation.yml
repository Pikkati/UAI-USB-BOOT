name: Swarm DIND Remediation Test

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  run-remediation:
    runs-on: self-hosted
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Debug list workspace contents
        run: |
          echo "Workspace root: $(pwd)"
          ls -la
          echo "Top-level files:"
          ls -la .
          echo "Checking presence of required files..."
          test -f SECURITY/history-purge/generate_issue_files.py && echo "SECURITY generate_issue_files: FOUND" || echo "SECURITY generate_issue_files: MISSING"
          test -f requirements-dev.txt && echo "requirements-dev.txt exists" || echo "requirements-dev.txt missing"
          test -f ci/Dockerfile.ci && echo "ci/Dockerfile.ci exists" || echo "ci/Dockerfile.ci missing"
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f
      - name: Build CI image (for test)
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25
        with:
          context: .
          file: ci/Dockerfile.ci
          load: true
          tags: uai-ci/swarm-remediation:pr-test
      - name: Run CA-mismatch remediation test inside CI image
        run: |
          docker run --rm -e PYTHONUNBUFFERED=1 -v "${{ github.workspace }}:/workspace" -w /workspace uai-ci/swarm-remediation:pr-test pytest tests/test_swarm_join_remediation.py -q
