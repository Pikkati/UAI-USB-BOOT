name: Deploy Image to Render (manual)

on:
  workflow_dispatch:
    inputs:
      image:
        description: 'Full image name (e.g., ghcr.io/org/uai-license-api:sha or :latest)'
        required: true

jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 5
      threshold_percent: 5
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
  deploy-image:
    needs: [credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Python
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Patch service & trigger deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -z "${RENDER_API_KEY}" ] || [ -z "${RENDER_SERVICE_ID}" ]; then
            echo "Render secrets not set - aborting"
            exit 1
          fi
          python .github/scripts/patch_and_deploy_render.py --service "$RENDER_SERVICE_ID" --api-key "$RENDER_API_KEY" --image "${{ github.event.inputs.image }}"

      - name: Wait for deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          python .github/scripts/wait_for_render_deploy.py --service "$RENDER_SERVICE_ID" --api-key "$RENDER_API_KEY" --timeout 600

      - name: Run smoke tests
        run: |
          python .github/scripts/run_smoke_tests.py --base-url https://uai-license-api.onrender.com

      - name: Fetch build logs and upload
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          python .github/scripts/fetch_build_logs.py --service "$RENDER_SERVICE_ID" --api-key "$RENDER_API_KEY" --out build_logs.txt
      - name: Upload logs artifact
        uses: actions/upload-artifact@ff15f0306b3f739f7b6fd43fb5d26cd321bd4de5
        with:
          name: render-manual-deploy-logs
          path: build_logs.txt
