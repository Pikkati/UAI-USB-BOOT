name: Monitoring Dashboard Update

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of dashboard update'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - emergency
  push:
    branches: [ metrics, scaling-events, pre-trigger-reports ]
    paths:
      - 'metrics/**'
      - 'scaling-events/**'
      - 'pre-trigger-reports/**'

jobs:
  update_dashboard:
    runs-on: [self-hosted, docker-swarm]
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0

      - name: Fetch Metrics Branch
        run: |
          git fetch origin metrics:metrics-branch || echo "Metrics branch not found"
          git fetch origin scaling-events:scaling-events-branch || echo "Scaling events branch not found"
          git fetch origin pre-trigger-reports:pre-trigger-reports-branch || echo "Pre-trigger reports branch not found"

      - name: Collect Dashboard Data
        run: |
          echo "📊 Collecting dashboard data..."

          # Create dashboard data directory
          mkdir -p dashboard-data

          # Get latest usage metrics
          LATEST_USAGE=$(find metrics-branch -name "usage-*.json" 2>/dev/null | sort | tail -1 || echo "")
          if [ -n "$LATEST_USAGE" ]; then
            cp "$LATEST_USAGE" dashboard-data/latest-usage.json
            echo "✅ Latest usage data collected"
          else
            echo '{"percentage_used": 0, "remaining_minutes": 30000, "included_minutes": 3000, "timestamp": "'$(date -Iseconds)'"}' > dashboard-data/latest-usage.json
            echo "⚠️ No usage data found, using defaults"
          fi

          # Get usage history (last 24 hours)
          mkdir -p dashboard-data/history
          find metrics-branch -name "usage-*.json" -mmin -1440 2>/dev/null | head -96 | while read -r file; do
            cp "$file" dashboard-data/history/
          done || echo "No historical data found"

          # Get scaling events (last 7 days)
          mkdir -p dashboard-data/scaling-events
          find scaling-events-branch -name "scaling-*.json" -mtime -7 2>/dev/null | while read -r file; do
            cp "$file" dashboard-data/scaling-events/
          done || echo "No scaling events found"

          # Get pre-trigger reports (last 24 hours)
          mkdir -p dashboard-data/pre-trigger-reports
          find pre-trigger-reports-branch -name "check-*.json" -mmin -1440 2>/dev/null | while read -r file; do
            cp "$file" dashboard-data/pre-trigger-reports/
          done || echo "No pre-trigger reports found"

          # Get workflow run statistics
          echo "🔄 Collecting workflow statistics..."
          WORKFLOW_STATS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100")

          echo "$WORKFLOW_STATS" | jq '{
            total_runs: (.workflow_runs | length),
            successful_runs: ([.workflow_runs[] | select(.conclusion == "success")] | length),
            failed_runs: ([.workflow_runs[] | select(.conclusion == "failure")] | length),
            in_progress_runs: ([.workflow_runs[] | select(.status == "in_progress")] | length),
            success_rate: (([.workflow_runs[] | select(.conclusion == "success")] | length) / (.workflow_runs | length) * 100),
            recent_runs: [.workflow_runs[0:10][] | {name: .name, status: .status, conclusion: .conclusion, created_at: .created_at}]
          }' > dashboard-data/workflow-stats.json

          # Generate dashboard configuration
          cat > dashboard-data/config.json << EOF
          {
            "last_updated": "$(date -Iseconds)",
            "update_type": "${{ github.event.inputs.update_type }}",
            "data_sources": {
              "usage_metrics": true,
              "workflow_stats": true,
              "scaling_events": true,
              "pre_trigger_reports": true
            },
            "alerts": {
              "high_usage_threshold": 80,
              "critical_usage_threshold": 95,
              "low_minutes_threshold": 500
            },
            "refresh_interval": 900000
          }
          EOF

          echo "📋 Dashboard data collection complete"

      - name: Update Dashboard HTML
        run: |
          echo "🎨 Updating dashboard HTML..."

          # Read current dashboard
          if [ -f "docs/dashboard/index.html" ]; then
            cp docs/dashboard/index.html dashboard-backup.html
          fi

          # Update the dashboard with new data
          # This would typically involve updating the HTML with new data URLs or inline data
          # For now, we'll update a timestamp and data version

          if [ -f "docs/dashboard/index.html" ]; then
            # Update last updated timestamp in HTML
            sed -i "s|Last updated:.*|Last updated: $(date)|g" docs/dashboard/index.html

            # Update data version
            sed -i "s|data-version=\"[^\"]*\"|data-version=\"$(date +%s)\"|g" docs/dashboard/index.html

            echo "✅ Dashboard HTML updated"
          else
            echo "⚠️ Dashboard HTML not found, skipping update"
          fi

      - name: Generate Dashboard Summary
        run: |
          echo "📊 Generating dashboard summary..."

          # Calculate key metrics
          USAGE=$(jq -r '.percentage_used' dashboard-data/latest-usage.json 2>/dev/null || echo "0")
          REMAINING=$(jq -r '.remaining_minutes' dashboard-data/latest-usage.json 2>/dev/null || echo "30000")

          WORKFLOW_COUNT=$(jq -r '.total_runs' dashboard-data/workflow-stats.json 2>/dev/null || echo "0")
          SUCCESS_RATE=$(jq -r '.success_rate' dashboard-data/workflow-stats.json 2>/dev/null || echo "0")

          SCALING_EVENTS=$(find dashboard-data/scaling-events -name "*.json" 2>/dev/null | wc -l)
          PRE_TRIGGER_CHECKS=$(find dashboard-data/pre-trigger-reports -name "*.json" 2>/dev/null | wc -l)

          # Generate summary
          cat > dashboard-data/summary.json << EOF
          {
            "timestamp": "$(date -Iseconds)",
            "current_usage_percentage": $USAGE,
            "remaining_minutes": $REMAINING,
            "total_workflow_runs": $WORKFLOW_COUNT,
            "workflow_success_rate": $SUCCESS_RATE,
            "scaling_events_count": $SCALING_EVENTS,
            "pre_trigger_checks_count": $PRE_TRIGGER_CHECKS,
            "data_points": {
              "usage_history": $(find dashboard-data/history -name "*.json" 2>/dev/null | wc -l),
              "scaling_events": $SCALING_EVENTS,
              "pre_trigger_reports": $PRE_TRIGGER_CHECKS
            },
            "alerts": {
              "high_usage": $(echo "$USAGE > 80" | bc -l),
              "critical_usage": $(echo "$USAGE > 95" | bc -l),
              "low_minutes": $(echo "$REMAINING < 500" | bc -l)
            }
          }
          EOF

          echo "📋 Dashboard summary generated:"
          cat dashboard-data/summary.json | jq .

      - name: Send Dashboard Update Notification
        run: |
          UPDATE_TYPE="${{ github.event.inputs.update_type }}"
          USAGE="$USAGE"
          REMAINING="$REMAINING"

          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            # Determine notification level
            if (( $(echo "$USAGE > 95" | bc -l) )) || [ "$UPDATE_TYPE" = "emergency" ]; then
              COLOR="danger"
              TITLE="🚨 Emergency Dashboard Update"
            elif (( $(echo "$USAGE > 80" | bc -l) )); then
              COLOR="warning"
              TITLE="⚠️ High Usage Dashboard Update"
            else
              COLOR="good"
              TITLE="📊 Dashboard Update"
            fi

            PAYLOAD=$(cat <<EOF
            {
              "attachments": [
                {
                  "color": "$COLOR",
                  "title": "$TITLE",
                  "text": "GitHub Actions monitoring dashboard has been updated.",
                  "fields": [
                    {
                      "title": "Current Usage",
                      "value": "${USAGE}%",
                      "short": true
                    },
                    {
                      "title": "Minutes Remaining",
                      "value": "${REMAINING}",
                      "short": true
                    },
                    {
                      "title": "Workflow Success Rate",
                      "value": "${SUCCESS_RATE}%",
                      "short": true
                    },
                    {
                      "title": "Update Type",
                      "value": "$UPDATE_TYPE",
                      "short": true
                    }
                  ],
                  "actions": [
                    {
                      "type": "button",
                      "text": "View Dashboard",
                      "url": "https://yushchyr.github.io/UAI_Copilot_Automation_Tool/dashboard/"
                    }
                  ],
                  "footer": "Monitoring Dashboard",
                  "ts": $(date +%s)
                }
              ]
            }
          EOF
          )

            curl -X POST -H 'Content-type: application/json' \
              --data "$PAYLOAD" \
              "${{ secrets.SLACK_WEBHOOK_URL }}" || echo "Dashboard notification failed"
          fi

      - name: Commit Dashboard Updates
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          # Check if there are changes to commit
          if git diff --quiet docs/dashboard/ dashboard-data/; then
            echo "No dashboard changes to commit"
          else
            git add docs/dashboard/
            git add dashboard-data/
            git commit -m "📊 Dashboard update - $UPDATE_TYPE - $(date)" || true
            git push origin HEAD:main || echo "Push to main failed"
          fi

      - name: Generate Update Summary
        run: |
          UPDATE_TYPE="${{ github.event.inputs.update_type }}"
          TRIGGER="${{ github.event_name }}"

          echo "## 📊 Monitoring Dashboard Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Current Usage | ${USAGE}% | $(if (( $(echo "$USAGE > 80" | bc -l) )); then echo "⚠️ High"; else echo "✅ Normal"; fi) |" >> $GITHUB_STEP_SUMMARY
          echo "| Minutes Remaining | ${REMAINING} | $(if [ "$REMAINING" -lt 500 ]; then echo "⚠️ Low"; else echo "✅ Good"; fi) |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Success Rate | ${SUCCESS_RATE}% | $(if (( $(echo "$SUCCESS_RATE < 90" | bc -l) )); then echo "⚠️ Low"; else echo "✅ Good"; fi) |" >> $GITHUB_STEP_SUMMARY
          echo "| Scaling Events | $SCALING_EVENTS | 📈 |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-Trigger Checks | $PRE_TRIGGER_CHECKS | 🏥 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔄 Update Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Type:** $UPDATE_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** $TRIGGER" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Dashboard automatically updates every 15 minutes and on data changes.*" >> $GITHUB_STEP_SUMMARY
          echo "*View live dashboard: https://yushchyr.github.io/UAI_Copilot_Automation_Tool/dashboard/*" >> $GITHUB_STEP_SUMMARY
