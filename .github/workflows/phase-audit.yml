name: Phase Audit & Tests
true:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 10
      threshold_percent: 3
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
      slack_webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
  audit:
    name: Phase Audit
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    - name: Set up Python
      uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
      with:
        python-version: '3.11'
    - name: Run phase audit
      run: 'python scripts/phase_audit.py --expected-file .phase_count_expected --output
        artifacts/phase_audit_report.json

        '
    - name: Upload phase audit report
      uses: actions/upload-artifact@ff15f0306b3f739f7b6fd43fb5d26cd321bd4de5
      with:
        name: phase-audit-report
        path: artifacts/phase_audit_report.json
    needs:
    - credit_check
  triage:
    name: Triage Missing Phases
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    needs:
    - audit
    - credit_check
    permissions:
      issues: write
      contents: read
    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    - name: Download phase audit report
      uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
      with:
        name: phase-audit-report
    - name: Create issue for missing phases
      uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410
      with:
        script: "const fs = require('fs');\nconst path = 'phase-audit-report/phase_audit_report.json';\n\
          if (!fs.existsSync(path)) {\n  core.info('No phase audit report found; skipping\
          \ triage.');\n  return;\n}\nconst report = JSON.parse(fs.readFileSync(path,\
          \ 'utf8'));\nconst missing = report.missing_phases || [];\nif (!missing.length)\
          \ {\n  core.info('No missing phases; nothing to do.');\n  return;\n}\nconst\
          \ title = `Phase Audit \u2014 Missing phases (${missing.length})`;\nconst\
          \ body = `Phase audit found missing phases:\\n\\n${missing.join(', ')}\\\
          n\\nArtifact: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}/artifacts\\\
          n\\nPlease triage these phases.`;\nconst { data: issues } = await github.rest.issues.listForRepo({\
          \ owner: context.repo.owner, repo: context.repo.repo, state: 'open', per_page:\
          \ 100 });\nif (issues.some(i => i.title === title)) {\n  core.info('An open\
          \ issue for this missing phases set already exists; skipping.');\n  return;\n\
          }\nawait github.rest.issues.create({\n  owner: context.repo.owner,\n  repo:\
          \ context.repo.repo,\n  title,\n  body,\n  labels: ['phase-gap','audit'],\n\
          });\n"
  tests:
    name: Run Tests
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    needs:
    - audit
    - credit_check
    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    - name: Set up Python
      uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
      with:
        python-version: '3.11'
    - name: Install test deps
      run: 'python -m pip install --upgrade pip

        # Only install dev/test deps to avoid heavy runtime dependency resolution
        conflicts

        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt;
        fi

        pip install pytest pytest-cov pytest-asyncio pytest-mock pytest-benchmark

        '
    - name: Run audit-only tests
      run: pytest -q tests/test_phase_audit.py
