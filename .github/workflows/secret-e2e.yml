name: Secrets E2E (guarded)

# Manual trigger + push; job runs only when required secrets are configured
on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 15
      threshold_percent: 5
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
  secrets-e2e:
    needs: [credit_check]
    if: ${{ secrets.GITHUB_TOKEN != '' && secrets.SET_GITHUB_SECRET_REPO != '' }}
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Python
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
        with:
          python-version: '3.11'

      - name: Install dependencies (minimal + test deps)
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements-minimal.txt
          pip install --no-cache-dir pytest pytest-asyncio

      - name: Run GitHub secret E2E test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SET_GITHUB_SECRET_REPO: ${{ secrets.SET_GITHUB_SECRET_REPO }}
          SECRET_ROTATION_TOKEN: ${{ secrets.SECRET_ROTATION_TOKEN }}
        run: |
          # Run only the E2E secret test to limit scope and exposure
          pytest -q tests/test_extension_security_github_e2e.py::test_e2e_rotate_and_scan_and_cleanup

      - name: Archive test result (always)
        if: always()
        uses: actions/upload-artifact@ff15f0306b3f739f7b6fd43fb5d26cd321bd4de5
        with:
          name: secrets-e2e-results
          path: .pytest_cache || ''
