name: Publish Documentation (MkDocs)
true:
  push:
    branches:
    - main
    paths:
    - docs/**
    - mkdocs.yml
    - '**/*.py'
  workflow_dispatch: null
permissions:
  contents: write
  pages: write
  id-token: write
concurrency:
  group: docs-${{ github.ref }}
  cancel-in-progress: true
jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 10
      threshold_percent: 3
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
      slack_webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
  build-and-deploy:
    if: ${{ github.event_name != 'pull_request' || contains(toJson(github.event.pull_request.labels),
      'ci:full') }}
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    - name: Setup Python
      uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install mkdocs-material mkdocstrings[python]

        # Optional: install project reqs if needed for docstring imports

        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

        '
    - name: Generate OpenAPI and Swagger UI
      run: "# Reuse the OpenAPI generation logic to embed into MkDocs site\npython\
        \ - << 'PY'\nimport json\nfrom pathlib import Path\npatterns = [\n  (\"api_gateway_engine.py\"\
        , \"app\"),\n  (\"api.py\", \"app\"),\n  (\"main.py\", \"app\"),\n  (\"analytics_api.py\"\
        , \"app\"),\n  (\"voice_ai_conversation_engine.py\", \"app\"),\n]\nspecs =\
        \ []\nfor file_name, app_name in patterns:\n    p = Path(file_name)\n    if\
        \ p.exists():\n        try:\n            m = __import__(p.stem)\n        \
        \    if hasattr(m, app_name):\n                app = getattr(m, app_name)\n\
        \                if hasattr(app, 'openapi'):\n                    schema =\
        \ app.openapi()\n                    schema.setdefault('info', {})\n     \
        \               schema['info']['title'] = schema['info'].get('title') or f\"\
        {p.stem.title()} API\"\n                    specs.append((p.stem, schema))\n\
        \        except Exception as e:\n            print(f\"Failed to generate spec\
        \ for {p}: {e}\")\nout = Path('docs/api/openapi')\nout.mkdir(parents=True,\
        \ exist_ok=True)\nfor name, schema in specs:\n    (out / f\"{name}.json\"\
        ).write_text(json.dumps(schema, indent=2))\n(out / 'index.json').write_text(json.dumps([n\
        \ for n,_ in specs]))\nPath('docs/api/generated').mkdir(parents=True, exist_ok=True)\n\
        Path('docs/api/generated/index.html').write_text('''<!DOCTYPE html><html lang=\"\
        en\"><head><meta charset=\"UTF-8\"><meta name=\"viewport\" content=\"width=device-width,\
        \ initial-scale=1.0\"><title>UAI Copilot API Documentation</title><link rel=\"\
        stylesheet\" href=\"https://unpkg.com/swagger-ui-dist@5/swagger-ui.css\"><style>body{margin:0;padding:0}#swagger-ui{max-width:1460px;margin:0\
        \ auto}</style></head><body><div id=\"swagger-ui\"></div><script src=\"https://unpkg.com/swagger-ui-dist@5/swagger-ui-bundle.js\"\
        ></script><script src=\"https://unpkg.com/swagger-ui-dist@5/swagger-ui-standalone-preset.js\"\
        ></script><script>window.onload=()=>{window.ui=SwaggerUIBundle({urls:[{name:\"\
        Main API\",url:\"./openapi/api.json\"},{name:\"Analytics API\",url:\"./openapi/analytics_api.json\"\
        },{name:\"Gateway\",url:\"./openapi/api_gateway_engine.json\"}],dom_id:'#swagger-ui',deepLinking:true,presets:[SwaggerUIBundle.presets.apis,SwaggerUIStandalonePreset],layout:\"\
        StandaloneLayout\"})};</script></body></html>\")''')\nPY\n"
    - name: Build MkDocs site
      run: 'mkdocs build --strict

        '
    - name: Setup Pages
      uses: actions/configure-pages@1f0c5cde4bc74cd7e1254d0cb4de8d49e9068c7d
    - name: Upload artifact
      uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa
      with:
        path: site
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e
    needs:
    - credit_check
