name: "Branch housekeeping"

on:
  schedule:
    - cron: "0 0 * * 0"
  workflow_dispatch: {}

jobs:
  prune:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - run: git fetch --prune origin
      - run: |
          merged=$(git branch -r --merged origin/main \
            | grep -vE 'origin/(main|HEAD|gh-pages)' \
            | sed 's#origin/##')
          if [ -n "$merged" ]; then
            for br in $merged; do
              echo "Deleting remote branch $br"
              gh api --method DELETE /repos/${GITHUB_REPOSITORY}/git/refs/heads/$br || true
            done
          else
            echo "no merged branches to remove"
          fi
      - run: |
          git remote prune origin
          for lb in $(git branch --merged main | egrep -v "\*|main"); do
            git branch -d "$lb" || true
          done
