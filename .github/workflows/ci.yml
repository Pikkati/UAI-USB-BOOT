jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 15
      threshold_percent: 3
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
      slack_webhook: ${{ secrets.SLACK_WEBHOOK_URL }}

  root-owned-precheck:
    needs: [credit_check]
    uses: ./.github/workflows/root-owned-precheck.yml
    with:
      runner: ${{ needs.credit_check.outputs.runner }}

  quality:
    needs: [credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

    - name: Setup Python
      uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: pip install -r requirements-dev.txt

    - name: Run pre-commit
      run: pre-commit run --all-files --show-diff-on-failure

  security:
    needs: [credit_check, quality]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

    - name: Determine changed files
      id: changes
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          git fetch origin ${{ github.event.pull_request.base.ref }}
          echo "files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only origin/${{ github.event.pull_request.base.ref }}..HEAD >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "files=." >> $GITHUB_OUTPUT
        fi

    - name: "Run Semgrep (PR: changed files only, else full repo)"
      run: |
        FILES="${{ steps.changes.outputs.files }}"
        FILES="$(echo "$FILES" | tr '\n' ' ')"
        echo "Files: $FILES"
        if [ "${{ github.event_name }}" = "pull_request" ] && [ -n "$FILES" ] && [ "$FILES" != "." ]; then
          echo "Running semgrep on changed files"
          docker run --rm -v "$PWD":/src -w /src returntocorp/semgrep-agent:v1 semgrep --config=auto $FILES
        else
          echo "Running semgrep on full repo"
          docker run --rm -v "$PWD":/src -w /src returntocorp/semgrep-agent:v1 semgrep --config=auto .
        fi

    - name: Setup Python (security)
      uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
      with:
        python-version: '3.11'

    - name: Install dependencies (security)
      run: pip install -r requirements-dev.txt

    - name: Run dependency scan
      run: |
        # Temporarily ignore ecdsa CVEs (64459, 64396) until upstream publishes a patch
        # TODO: track and remove this ignore when fixed (create issue to track)
        safety check --ignore 64459,64396

    - name: Run pip-audit for dependency vulnerabilities
      run: |
        pip install pip-audit
        pip-audit --format json --output pip-audit-results.json || true
        echo "pip-audit scan completed"

    - name: Run Bandit security scan
      run: |
        pip install bandit
        bandit -r . -x venv,node_modules,.venv,dist,build --format json --output bandit-results.json || true
        echo "Bandit scan completed"

    - name: Upload security scan results
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
      with:
        name: security-scan-results
        path: |
          bandit-results.json
          pip-audit-results.json

    - name: Run tests
      run: python -m pytest tests/ -v
  test:
    needs: [credit_check, quality]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    env:
      SKIP_TESTS_AWS: 'true'
      SKIP_TESTS_AZURE: 'true'
    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    - name: Setup Python
      uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: pip install -r requirements-dev.txt
    - name: Run tests
      run: python -m pytest tests/ -v
    - name: Run make tests (legacy)
      run: make test || true
name: CI/CD Pipeline
'on':
- push
- pull_request
