# UAI Cloud CI/CD Pipeline Configuration
# GitHub Actions workflow for automated deployment

# UAI Cloud CI/CD Pipeline Configuration
# GitHub Actions workflow for automated deployment

name: UAI Cloud Infrastructure CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: uai-copilot-automation
  CLUSTER_NAME: uai-production-cluster

jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 30
      threshold_percent: 5
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
      slack_webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
  test:
    needs: [credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
    - uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada26756

    - name: Set up Python
      uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
        pip install pytest pytest-cov pytest-asyncio pytest-mock pytest-benchmark black flake8

    - name: Run tests
      run: |
        python -m pytest tests/
        python -m black --check .
        python -m flake8 .

    - name: Docker security scan
      run: |
        docker run --rm -v $(pwd):/app -w /app aquasec/trivy fs .

  build:
    needs: [test, credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
    - uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada26756

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f

    - name: Login to Container Registry
      uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25
      with:
        context: .
        build-args: |
          SKIP_HEAVY=1
        push: true
        tags: |
          ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=registry,ref=ghcr.io/${{ github.repository }}:buildcache
        cache-to: type=registry,ref=ghcr.io/${{ github.repository }}:buildcache,mode=max

  deploy-staging:
    needs: [build, credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    if: github.ref == 'refs/heads/develop' && false # AWS Suspended (Issue #13)
    steps:
    - uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada26756

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@5fd3084fc36e372ff1fff382a39b10d03659f355
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Deploy to ECS Staging
      run: |
        aws ecs update-service --cluster uai-staging-cluster
        --service uai-copilot-service --force-new-deployment

  deploy-production:
    needs: [build, credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    if: github.ref == 'refs/heads/main' && false # AWS Suspended (Issue #13)
    environment: production
    steps:
    - uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada26756

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@5fd3084fc36e372ff1fff382a39b10d03659f355
      with:
        aws-access-key-id: ${{ secrets.AWS_PROD_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_PROD_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Deploy to ECS Production
      run: |
        aws ecs update-service --cluster uai-production-cluster
        --service uai-copilot-service --force-new-deployment

    - name: Update Kubernetes deployment
      run: |
        aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }}
        kubectl set image deployment/uai-copilot-app
        uai-copilot=${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        kubectl rollout status deployment/uai-copilot-app

  security-scan:
    needs: [credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
    - uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada26756

    - name: Run security scans
      run: |
        # Container security scan
        docker run --rm -v $(pwd):/app -w /app aquasec/trivy fs .

        # Infrastructure security scan
        docker run --rm -v $(pwd):/app -w /app bridgecrew/checkov -f docker-compose.enhanced.yml

        # SAST scan
        docker run --rm -v $(pwd):/app -w /app returntocorp/semgrep --config=auto .

        # Secret scan (gitleaks)
        docker run --rm -v $(pwd):/src -w /src
        zricethezav/gitleaks:latest detect --source /src --report-format json --report-path gitleaks-report.json --exit-code 1

  performance-test:
    needs: [deploy-staging, credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
    - uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada26756

    - name: Install k6
      run: |
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6

    - name: Run performance tests
      run: |
        k6 run tests/performance/load-test.js
        k6 run tests/performance/stress-test.js
