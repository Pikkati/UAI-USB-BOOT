name: Build & Push Docker (Self-hosted)

on:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: [self-hosted, docker-swarm]

    steps:
      - name: Prepare runner
        run: |
          set -euo pipefail
          echo "Checking docker/buildx"
          docker version || true
          docker buildx version || true

      - name: Clone repository
        env:
          GIT_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          rm -rf repo || true
          git clone https://${{ github.repository_owner }}:${GIT_TOKEN}@github.com/${{ github.repository }} repo
          cd repo
          SHA=$(git rev-parse --short HEAD)
          echo "IMAGE_TAG=ghcr.io/${{ github.repository_owner }}/uai-license-api:${SHA}" >> $GITHUB_ENV

      - name: Build Docker image
        run: |
          set -euo pipefail
          cd repo/uai-license-api
          echo "Building $IMAGE_TAG"
          docker build -t "$IMAGE_TAG" -f Dockerfile.production .

      - name: Login to GHCR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$GITHUB_TOKEN" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

      - name: Push image
        run: |
          set -euo pipefail
          docker push "$IMAGE_TAG"

      - name: Update Render service to use image & trigger deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip
          pip install requests
          python .github/scripts/patch_and_deploy_render.py --service "$RENDER_SERVICE_ID" --api-key "$RENDER_API_KEY" --image "$IMAGE_TAG"

      - name: Wait for Render deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          set -euo pipefail
          python .github/scripts/wait_for_render_deploy.py --service "$RENDER_SERVICE_ID" --api-key "$RENDER_API_KEY" --timeout 600

      - name: Run smoke tests against deployed app
        run: |
          set -euo pipefail
          python .github/scripts/run_smoke_tests.py --base-url https://uai-license-api.onrender.com
