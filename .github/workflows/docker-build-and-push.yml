name: Build and Push Docker image

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 20
      threshold_percent: 5
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
  build-and-push:
    needs: [credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up QEMU
        uses: docker/setup-qemu-action@68827325e0b33c7199eb31dd4e31fbe9023e06e3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25
        with:
          context: ./uai-license-api
          file: ./uai-license-api/Dockerfile.production
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/uai-license-api:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/uai-license-api:latest

      - name: Notify
        run: |
          echo "Image pushed: ghcr.io/${{ github.repository_owner }}/uai-license-api:${{ github.sha }}"

      - name: Set IMAGE_TAG
        run: echo "IMAGE_TAG=ghcr.io/${{ github.repository_owner }}/uai-license-api:${{ github.sha }}" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Update Render service to use image & trigger deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          if [ -z "${RENDER_API_KEY}" ] || [ -z "${RENDER_SERVICE_ID}" ]; then
            echo "RENDER_API_KEY or RENDER_SERVICE_ID not set - skipping Render update/deploy"
            exit 0
          fi
          python .github/scripts/patch_and_deploy_render.py --service "$RENDER_SERVICE_ID" --api-key "$RENDER_API_KEY" --image "$IMAGE_TAG"

      - name: Wait for Render deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          python .github/scripts/wait_for_render_deploy.py --service "$RENDER_SERVICE_ID" --api-key "$RENDER_API_KEY" --timeout 600

      - name: Run smoke tests against deployed app
        run: |
          python .github/scripts/run_smoke_tests.py --base-url https://uai-license-api.onrender.com

      - name: Fetch Render build logs
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          python .github/scripts/fetch_build_logs.py --service "$RENDER_SERVICE_ID" --api-key "$RENDER_API_KEY" --out build_logs.txt

      - name: Upload build logs artifact
        uses: actions/upload-artifact@ff15f0306b3f739f7b6fd43fb5d26cd321bd4de5
        with:
          name: render-build-logs
          path: build_logs.txt
