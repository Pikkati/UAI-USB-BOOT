name: Build & Publish SSH Key Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ssh-key-server

jobs:
  build:
    runs-on: [self-hosted, docker-swarm]
    steps:
      - uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada26756

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ssh-key-server image
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25
        with:
          context: deploy/ssh-key-server
          file: deploy/ssh-key-server/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy-swarm:
    needs: build
    runs-on: [self-hosted, docker-swarm]
    if: ${{ secrets.SWARM_HOST && secrets.SWARM_SSH_PRIVATE_KEY && secrets.SWARM_SSH_USER && secrets.SWARM_SERVICE_NAME }}
    steps:
      - name: Update Swarm service via SSH
        uses: appleboy/ssh-action@d91a1af6f57cd4478ceee14d7705601dafabaa19
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_SSH_USER }}
          key: ${{ secrets.SWARM_SSH_PRIVATE_KEY }}
          script: |
            echo "Updating Swarm service ${{ secrets.SWARM_SERVICE_NAME }} to image ghcr.io/${{ github.repository }}/ssh-key-server:${{ github.sha }}"
            docker service update --image ghcr.io/${{ github.repository }}/ssh-key-server:${{ github.sha }} ${{ secrets.SWARM_SERVICE_NAME }} || true
