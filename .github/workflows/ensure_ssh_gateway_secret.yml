name: Ensure SSH Gateway Secret

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read
  actions: write
  secrets: write
  issues: write

jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 10
      threshold_percent: 5
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
  ensure-secret:
    needs: [credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Python
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Check for existing SSH_GATEWAY_ROOT_PASSWORD secret
        id: check-secret
        run: |
          python - <<'PY'
          import os, sys, json, requests
          repo = os.environ.get('GITHUB_REPOSITORY')
          if not repo:
              print(json.dumps({'error': 'GITHUB_REPOSITORY not set'}))
              sys.exit(1)
          owner, repo_name = repo.split('/')
          token = os.environ.get('GITHUB_TOKEN')
          if not token:
              print(json.dumps({'error': 'GITHUB_TOKEN not available'}))
              sys.exit(1)
          url = f'https://api.github.com/repos/{owner}/{repo_name}/actions/secrets'
          r = requests.get(url, headers={'Authorization': f'token {token}', 'Accept': 'application/vnd.github+json'}, timeout=10)
          r.raise_for_status()
          secrets = r.json().get('secrets', [])
          found = any(s.get('name') == 'SSH_GATEWAY_ROOT_PASSWORD' for s in secrets)
          # communicate result via GITHUB_OUTPUT
          with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
              fh.write(f'found={str(found).lower()}\n')
          print(json.dumps({'found': found}))
          if found:
              sys.exit(0)
          else:
              sys.exit(0)
          PY

      - name: Create SSH secret if missing
        if: steps.check-secret.outputs.found == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SECRET_NAME: SSH_GATEWAY_ROOT_PASSWORD
        run: |
          python - <<'PY'
          import os, sys, secrets, string, subprocess
          repo = os.environ.get('GITHUB_REPOSITORY')
          if not repo:
              print('GITHUB_REPOSITORY missing'); sys.exit(1)
          # Generate strong password
          alphabet = string.ascii_letters + string.digits + '!@#$%&*()-_=+'
          pw = ''.join(secrets.choice(alphabet) for _ in range(32))
          # Use rotate_github_secret.py to set the secret (this will encrypt and set via GitHub API)
          env = os.environ.copy()
          env['SECRET_VALUE'] = pw
          env['GITHUB_TOKEN'] = env.get('GITHUB_TOKEN')
          # Do not echo the secret value to logs
          res = subprocess.run(['python', 'scripts/rotate_github_secret.py', '--repo', repo], env=env, capture_output=True, text=True)
          print('rotate exit code:', res.returncode)
          if res.returncode != 0:
              print('ERROR:', res.stderr)
              sys.exit(1)
          print('OK: SSH_GATEWAY_ROOT_PASSWORD created')
          PY

      - name: Dispatch SSH Gateway integration run
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const workflow_id = 'ssh-gateway-integration.yml';
            await github.rest.actions.createWorkflowDispatch({ owner, repo, workflow_id, ref: 'main' });
            core.info('Dispatched ssh-gateway-integration workflow');

      - name: Notify via issue
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = 'Automated SSH Gateway Secret Provisioning';
            const body = `The repository secret 'SSH_GATEWAY_ROOT_PASSWORD' was ensured by workflow run at ${new Date().toISOString()} and ssh-gateway integration tests were dispatched.`;
            const issues = await github.rest.issues.listForRepo({ owner, repo, state: 'open', per_page: 100 });
            let issue = issues.data.find(i => i.title === title);
            if (issue) {
              await github.rest.issues.createComment({ owner, repo, issue_number: issue.number, body });
            } else {
              await github.rest.issues.create({ owner, repo, title, body });
            }
