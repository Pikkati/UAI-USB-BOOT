name: Distribute Swarm Worker Token

on:
  workflow_dispatch:
    inputs:
      manager_ip:
        description: 'Manager IP address to receive the token'
        required: true
        default: '10.30.60.232'
      manager_user:
        description: 'SSH user on manager to connect as'
        required: true
        default: 'root'
      start_http_server:
        description: 'Start a simple token HTTP server on manager (default: true)'
        required: true
        default: 'true'

jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 5
      threshold_percent: 5
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
  distribute-token:
    needs: [credit_check]
    name: Distribute Token
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}

    steps:
      - name: Verify repository secrets
        run: |
          if [ -z "${{ secrets.SWARM_WORKER_TOKEN }}" ] || [ -z "${{ secrets.DEPLOY_SSH_KEY }}" ]; then
            echo "Required secrets SWARM_WORKER_TOKEN and DEPLOY_SSH_KEY are not set. Please add them to repository secrets."; exit 1
          fi

      - name: Validate inputs
        run: |
          if [ -z "${{ github.event.inputs.manager_ip }}" ]; then
            echo "manager_ip is required"; exit 1
          fi

      - name: Prepare SSH key
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ github.event.inputs.manager_ip }}" >> ~/.ssh/known_hosts

      - name: Upload token to manager
        env:
          SWARM_WORKER_TOKEN: ${{ secrets.SWARM_WORKER_TOKEN }}
        run: |
          echo "Deploying swarm worker token to ${GITHUB_REPOSITORY} -> ${{ github.event.inputs.manager_ip }}"
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${{ github.event.inputs.manager_user }}"@"${{ github.event.inputs.manager_ip }}" "sudo mkdir -p /srv/scripts && echo \"$SWARM_WORKER_TOKEN\" | sudo tee /srv/scripts/swarm-token > /dev/null && sudo chmod 600 /srv/scripts/swarm-token"

      - name: Start simple token HTTP server (optional)
        if: ${{ github.event.inputs.start_http_server == 'true' }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${{ github.event.inputs.manager_user }}"@"${{ github.event.inputs.manager_ip }}" "sudo nohup python3 -m http.server 8888 --directory /srv/scripts >/var/log/swarm-token-http.log 2>&1 & sleep 1 || true"

      - name: Verify token presence
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${{ github.event.inputs.manager_user }}"@"${{ github.event.inputs.manager_ip }}" "curl -fsS http://127.0.0.1:8888/swarm-token || (echo 'token not found' && exit 1)" && echo 'token reachable'

      - name: Finish
        run: echo "Token distributed to manager ${{ github.event.inputs.manager_ip }}"
