name: Debug workspace cleanup and permissions

on:
  workflow_dispatch:

jobs:
  debug-workspace:
    runs-on: [self-hosted, docker-swarm]
    steps:
      - name: Gather workspace diagnostics (pre-checkout)
        run: |
          set -x
          exec > >(tee -a debug_workspace.txt) 2>&1
          echo "PWD: $(pwd)"
          echo "Top-level before checkout:"
          ls -la || true
          if [ -d .pytest_cache ]; then
            echo ".pytest_cache exists before checkout; listing and collecting diagnostics"
            echo "ls -la .pytest_cache:"
            ls -la .pytest_cache || true
            echo "stat for .pytest_cache and children:"
            stat -c "File: %n\nOwner: %U:%G\nPerms: %A (%a)\nSize: %s\nModTime: %y\n" .pytest_cache .pytest_cache/* 2>/dev/null || stat -c "File: %n\nOwner: %U:%G\nPerms: %A (%a)\nSize: %s\nModTime: %y\n" .pytest_cache 2>&1 || true
            echo "lsattr (if available):"
            which lsattr >/dev/null 2>&1 && lsattr -R .pytest_cache || echo "lsattr not available or failed" || true
            echo "getfacl (if available):"
            which getfacl >/dev/null 2>&1 && getfacl -an .pytest_cache || echo "getfacl not available or failed" || true
            echo "lsof +D (may require sudo):"
            sudo -n lsof +D .pytest_cache 2>/dev/null || lsof +D .pytest_cache 2>/dev/null || true
            echo "fuser -v .pytest_cache (may require sudo):"
            sudo -n fuser -v .pytest_cache 2>/dev/null || fuser -v .pytest_cache 2>/dev/null || true
            echo "find /proc/*/fd -ls | grep .pytest_cache (file descriptors):"
            find /proc/*/fd -ls 2>/dev/null | grep .pytest_cache || true
            echo "Processes (ps aux filtered):"
            ps aux | egrep -i 'docker|git|pytest|python|lsof|fuser' || true
            echo "Attempt chmod & rm (non-sudo):"
            chmod -R a+rwX .pytest_cache || true
            rm -rf .pytest_cache || true
            echo "Attempt sudo chown & rm (non-interactive):"
            sudo -n chown -R $(whoami):$(id -gn) .pytest_cache 2>/dev/null || true
            sudo -n rm -rf .pytest_cache 2>/dev/null || true
            echo "After attempted removal, .pytest_cache exists? (exit code: $?):"
            [ -d .pytest_cache ] && echo "still exists" || echo "removed or not present"
          else
            echo ".pytest_cache not present before checkout"
          fi
          echo "After attempts: top-level files"
          ls -la || true
        shell: bash

      - name: Workspace debug (save snapshot)
        run: |
          set -x
          echo "User: $(whoami)" >> debug_workspace.txt || true
          echo "UID/GID:" >> debug_workspace.txt || true
          id >> debug_workspace.txt || true
          echo "Top-level (first 2000 lines):" >> debug_workspace.txt || true
          ls -laR . | sed -n '1,2000p' >> debug_workspace.txt || true
          echo "Find .pytest_cache (if any):" >> debug_workspace.txt || true
          find . -maxdepth 4 -type d -name '.pytest_cache' -print -exec ls -la {} \; >> debug_workspace.txt || true
        shell: bash

      - name: Upload debug artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: debug-workspace
          path: debug_workspace.txt
