name: Secret scanning (gitleaks)
permissions:
  contents: read
true:
  pull_request:
    branches:
    - main
  push:
    branches:
    - main
jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 10
      threshold_percent: 3
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
      slack_webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
  secret-scan:
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    - name: Run Gitleaks
      uses: zricethezav/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7
      with:
        args: detect --source . --report-format json --report-path gitleaks-report.json
          --exit-code 1
    - name: Upload gitleaks report
      if: failure()
      uses: actions/upload-artifact@ff15f0306b3f739f7b6fd43fb5d26cd321bd4de5
      with:
        name: gitleaks-report
        path: gitleaks-report.json
    needs:
    - credit_check
