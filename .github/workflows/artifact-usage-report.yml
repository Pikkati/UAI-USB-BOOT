name: Artifact & Cache Usage Report

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch for metrics (default: metrics)'
        required: false
        default: 'metrics'
  schedule:
    - cron: '0 3 * * *'  # Daily at 03:00 UTC

permissions:
  contents: write
  actions: read
  issues: write

jobs:
  report:
    runs-on: [self-hosted]
    timeout-minutes: 10
    steps:
      - name: Gather artifact & cache usage
        id: report
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const targetBranch = process.env.INPUT_TARGET_BRANCH || 'metrics';
            const now = new Date().toISOString();

            // Artifacts
            const artifactsResp = await github.rest.actions.listArtifactsForRepo({ owner, repo, per_page: 100 });
            const artifacts = (artifactsResp.data.artifacts || []).map(a => ({ id: a.id, name: a.name, size_in_bytes: a.size_in_bytes, expired: a.expired, created_at: a.created_at }));
            const artifactTotal = artifacts.reduce((s, a) => s + (a.size_in_bytes || 0), 0);

            // Caches (best-effort)
            let caches = [];
            try {
              const cachesResp = await github.rest.actions.listRepoCaches({ owner, repo, per_page: 100 });
              caches = (cachesResp.data.caches || []).map(c => ({ id: c.id, key: c.key, size_in_bytes: c.size_in_bytes }));
            } catch (err) {
              // Some repos/orgs may not have caches or API may restrict access
              caches = [];
            }
            const cacheTotal = caches.reduce((s, c) => s + (c.size_in_bytes || 0), 0);

            const report = {
              timestamp: now,
              artifact_count: artifacts.length,
              artifact_total_bytes: artifactTotal,
              cache_count: caches.length,
              cache_total_bytes: cacheTotal,
              artifacts,
              caches
            };

            const safeName = now.replace(/[:.]/g,'-');
            const path = `metrics/artifacts-${safeName}.json`;

            // Ensure branch exists or create it from main
            let branchExists = true;
            try {
              await github.rest.repos.getBranch({ owner, repo, branch: targetBranch });
            } catch (e) {
              branchExists = false;
            }

            if (!branchExists) {
              const mainBranch = await github.rest.repos.getBranch({ owner, repo, branch: 'main' });
              const sha = mainBranch.data.commit.sha;
              await github.rest.git.createRef({ owner, repo, ref: `refs/heads/${targetBranch}`, sha });
            }

            const content = Buffer.from(JSON.stringify(report, null, 2)).toString('base64');

            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path,
              message: `chore(metrics): artifact usage report ${now}`,
              content,
              branch: targetBranch
            });

            core.setOutput('path', path);

      - name: Create tracking issue comment
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const path = '${{ steps.report.outputs.path }}';
            const issueNumber = 280;
            await github.rest.issues.createComment({ owner, repo, issue_number: issueNumber, body: `Artifact usage report written to \`${path}\` on branch \`metrics\`.` });
