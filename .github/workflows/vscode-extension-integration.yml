name: VS Code Extension Integration

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read
  actions: read
  issues: write

jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 10
      threshold_percent: 5
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
  test:
    needs: [credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Python
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest requests

      - name: Run integration tests (extension)
        run: |
          pytest -q tests/test_extension_security_api.py -q || pytest -q test_vscode_extension_final.py -q

  sync-extension:
    needs: [test, credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    if: secrets.EXTENSION_PAT != ''
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Python
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
        with:
          python-version: '3.11'

      - name: Sync extension repository (PR)
        env:
          EXTENSION_PAT: ${{ secrets.EXTENSION_PAT }}
          EXTENSION_REPO: ${{ secrets.EXTENSION_REPO }}
        run: |
          python scripts/sync_extension.py --repo "$EXTENSION_REPO" --pat "$EXTENSION_PAT"
