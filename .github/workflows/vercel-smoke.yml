name: Vercel Health Smoke Test
true:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
  workflow_dispatch: null
jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 10
      threshold_percent: 3
      fallback_runner: '["self-hosted","swarm"]'
      slack_webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
  vercel-smoke:
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    env:
      VERCEL_HEALTH_URL: ${{ secrets.VERCEL_HEALTH_URL }}
    steps:
    - name: Check Vercel health endpoint
      run: "set -e\nURL=\"${{ env.VERCEL_HEALTH_URL }}\"\nif [ -z \"$URL\" ]; then\n\
        \  echo \"::warning::VERCEL_HEALTH_URL not set; skipping Vercel health smoke\
        \ test.\"; exit 0\nfi\necho \"Checking $URL\"\n\nMAX_RETRIES=8\nDELAY=3\n\
        attempt=1\nstatus=0\n\nwhile [ $attempt -le $MAX_RETRIES ]; do\n  status=$(curl\
        \ -s -o /dev/null -w \"%{http_code}\" \"$URL\") || true\n\n  # Success\n \
        \ if [ \"$status\" -eq 200 ]; then\n    echo \"Health check passed: HTTP $status\
        \ (attempt $attempt)\"; exit 0\n  fi\n\n  # Try common fallback health paths\
        \ when 404 is returned\n  if [ \"$status\" -eq 404 ]; then\n    FALLBACKS=(\"\
        /health\" \"/api/health\" \"/health/degraded\" \"/api/health/degraded\")\n\
        \    for f in \"${FALLBACKS[@]}\"; do\n      fb_status=$(curl -s -o /dev/null\
        \ -w \"%{http_code}\" \"$URL${f}\" 2>/dev/null || true)\n      if [ \"$fb_status\"\
        \ -eq 200 ]; then\n        echo \"Health check passed on fallback path $f:\
        \ HTTP $fb_status (attempt $attempt)\"; exit 0\n      fi\n    done\n\n   \
        \ # On PRs, 404s are often due to preview not being ready; add extra diagnostic\
        \ output\n    if [ \"${GITHUB_EVENT_NAME:-}\" = \"pull_request\" ]; then\n\
        \      echo \"::warning::Health check returned 404 for main URL and all fallbacks;\
        \ showing small diagnostic output from main URL:\";\n      echo \"--- headers\
        \ ---\";\n      curl -s -D - -o /dev/null \"$URL\" 2>/dev/null || true;\n\
        \      echo \"--- body (first 1024 bytes) ---\";\n      curl -s \"$URL\" 2>/dev/null\
        \ | head -c 1024 || true;\n      echo \"::warning::Preview deployment may\
        \ not have the health endpoint; skipping health check for PR preview.\";\n\
        \      exit 0\n    fi\n  fi\n\n  # Detect Vercel preview protection (401 +\
        \ SSO nonce cookie or auth HTML)\n  if [ \"$status\" -eq 401 ]; then\n   \
        \ hdrs=$(curl -s -D - -o /dev/null \"$URL\" 2>/dev/null || true)\n    body=$(curl\
        \ -s \"$URL\" 2>/dev/null || true)\n\n    if echo \"$hdrs\" | grep -qi '_vercel_sso_nonce'\
        \ || echo \"$body\" | grep -qi 'Authentication Required\\|Vercel Authentication';\
        \ then\n      if [ \"${GITHUB_EVENT_NAME:-}\" = \"pull_request\" ]; then\n\
        \        echo \"::warning::Preview deployment requires Vercel authentication\
        \ (401). Skipping health check for PR preview.\"; exit 0\n      else\n   \
        \     echo \"::error::Production returned 401 (unexpected). Check Vercel project\
        \ protection settings.\"; echo \"$hdrs\"; exit 1\n      fi\n    fi\n  fi\n\
        \n  echo \"Health check attempt $attempt returned $status; retrying in ${DELAY}s...\"\
        \n  sleep $DELAY\n  attempt=$((attempt+1))\n  DELAY=$((DELAY*2))\ndone\n\n\
        echo \"::error::Health check failed after $MAX_RETRIES attempts: HTTP $status\"\
        ; exit 1"
    needs:
    - credit_check
