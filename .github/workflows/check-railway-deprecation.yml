name: Check Railway Deprecation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  check-railway-deprecation:
    name: Check Railway Deprecation
    runs-on: [self-hosted, docker-swarm]

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Python 3.11
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('.github/ci/requirements-railway-check.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install test requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/ci/requirements-railway-check.txt

      - name: Run Railway deprecation test
        run: pytest -q uai-license-api/tests/test_deploy_railway_deprecated.py -q
