name: E2E Tests
true:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 10
      threshold_percent: 3
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
      slack_webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
  e2e:
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    - name: Set up Python
      uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
      with:
        python-version: '3.11'
    - name: Install Python dependencies (minimal for E2E)
      run: '# Show disk usage for diagnostics

        df -h

        python -m pip install --upgrade pip

        # Install minimal runtime deps to avoid heavy ML packages in CI

        pip install --no-cache-dir -r requirements-minimal.txt

        # Verify critical packages are available

        python -c "import fastapi, uvicorn, sys; print(''fastapi'', fastapi.__version__,
        ''uvicorn'', uvicorn.__version__); print(''Python'', sys.version)"

        '
    - name: Set up Node.js
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
      with:
        node-version: '20'
    - name: Build frontend
      working-directory: ./react_dashboard
      run: 'npm ci

        npm run build

        '
    - name: Install e2e deps
      working-directory: ./react_dashboard/e2e
      run: 'npm ci

        npx playwright install --with-deps

        '
    - name: Start supervisor (background)
      run: 'nohup python3 run_api_supervisor.py &

        sleep 5

        '
    - name: Wait for backend
      run: 'for i in {1..30}; do nc -z 127.0.0.1 8002 && break || sleep 1; done

        '
    - name: Run Playwright tests
      working-directory: ./react_dashboard/e2e
      run: 'npm test

        '
    - name: Archive test artifacts
      if: always()
      uses: actions/upload-artifact@ff15f0306b3f739f7b6fd43fb5d26cd321bd4de5
      with:
        name: e2e-downloads
        path: react_dashboard/e2e/downloads || ''
    needs:
    - credit_check
