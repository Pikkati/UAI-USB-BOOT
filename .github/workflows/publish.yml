name: Publish Extension

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 10
      threshold_percent: 5
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
  publish:
    needs: [credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build bundle
        run: npm run bundle

      - name: Run package (create .vsix)
        run: npx @vscode/vsce@latest package

      - name: Publish to VS Code Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          if [ -z "${VSCE_PAT}" ]; then
            echo "VSCE_PAT secret is missing. Add it to repository secrets."; exit 1
          fi
          npx @vscode/vsce@latest publish

      - name: Upload VSIX artifact
        if: always()
        uses: actions/upload-artifact@ff15f0306b3f739f7b6fd43fb5d26cd321bd4de5
        with:
          name: vsix
          path: '*.vsix'
