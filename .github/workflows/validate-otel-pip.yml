name: Validate optional OpenTelemetry (pip + lightweight image)

on:
  schedule:
    - cron: '0 4 * * *' # daily at 04:00 UTC
  workflow_dispatch:
  pull_request:
    branches: [ main, develop ]

jobs:
  pip-validate:
    runs-on: [self-hosted, docker-swarm]
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
        with:
          python-version: '3.11'
      - run: python -m pip install --upgrade pip
      - run: bash ci/verify-otel.sh

  ci-image-otel:
    runs-on: [self-hosted, docker-swarm]
    needs: pip-validate
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Set up Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build lightweight OTEL test image
        run: |
          docker buildx build --progress=plain \
            --cache-from type=registry,ref=ghcr.io/${{ github.repository }}:buildcache \
            --cache-to type=registry,ref=ghcr.io/${{ github.repository }}:buildcache,mode=max \
            -f ci/Dockerfile-otel \
            -t uai-otel-ci:latest .
      - name: Verify import inside container
        run: |
          docker run --rm uai-otel-ci:latest python - <<'PY'
          import importlib.metadata as m
          import opentelemetry
          print('inside docker import OK')
          try:
              print('opentelemetry-api', m.version('opentelemetry-api'))
          except Exception:
              pass
          PY
      - name: Clean up
        run: docker rmi uai-otel-ci:latest || true
