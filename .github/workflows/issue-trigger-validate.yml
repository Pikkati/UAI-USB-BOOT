name: Issue Comment → Trigger Deploy Validation

on:
  issue_comment:
    types: [created]

permissions:
  actions: write
  issues: write
  contents: read
  administration: read

jobs:
  trigger_if_proceed:
    runs-on: [self-hosted, docker-swarm]
    steps:
      - name: Check for 'Proceed' comment (local-only)
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = context.payload.comment.body || '';
            const issue = context.payload.issue || {};
            const title = (issue.title || '').toLowerCase();
            if (!/proceed/i.test(comment)) {
              console.log('No proceed keyword found; ignoring.');
              return;
            }
            if (!/deploy token checks failed/i.test(title) && !/deploy token validation/i.test(title)) {
              console.log('Issue title does not match expected validation issue; ignoring.');
              return;
            }

            console.log('Proceed comment found — attempting to dispatch on-prem validator first. Per repository policy (No Hosted), we will NOT dispatch a hosted fallback. If the on-prem runner is offline, bring a runner labeled "docker-swarm" online and comment Proceed again.');

            try {
              await github.rest.actions.createWorkflowDispatch({ owner: context.repo.owner, repo: context.repo.repo, workflow_id: 'validate-deploy-secrets.yml', ref: 'main', inputs: { auto_dispatch: 'true', debug_dispatch: 'false' } });
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: issue.number, body: `Proceed by @${context.actor}: dispatched **on-prem validator** (validate-deploy-secrets.yml) with auto_dispatch=true. If the on-prem runner is offline the run will queue and may fail; ensure a self-hosted runner labeled 'docker-swarm' is online for auto-deploy.` });
              console.log('On-prem validator dispatched.');
            } catch (err) {
              console.log('On-prem dispatch failed — not dispatching hosted fallback due to local-only policy (No Hosted). Error:', err.message);
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: issue.number, body: `Proceed by @${context.actor}: could not dispatch **on-prem validator** (likely due to runner availability or permissions). Per repository policy, we will NOT run hosted fallback validators that consume GitHub-hosted minutes. Please bring a self-hosted runner labeled 'docker-swarm' online and then comment **Proceed** again to retry.` });
            }
