name: Root-owned files pre-check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
  workflow_call:
    inputs:
      runner:
        description: 'JSON array of runner labels (e.g., ["self-hosted","docker-swarm"]) or single label'
        required: false
        type: string
        default: '["self-hosted"]'

jobs:
  root-owned-check:
    name: Detect root-owned files (pre-check)
    runs-on: ${{ fromJson(inputs.runner || '["self-hosted"]') }}
    steps:
      - name: Gather workspace diagnostics (pre-checkout)
        shell: bash
        run: |
          set -x
          exec > >(tee -a debug_workspace_root_precheck.txt) 2>&1
          echo "PWD: $(pwd)"
          echo "User: $(whoami)"
          echo "Top-level before checkout:"; ls -la || true
          echo "Find root-owned files (maxdepth 4):"
          find . -maxdepth 4 -user root -printf "%p\n" > root_owned.txt || true
          if [ -s root_owned.txt ]; then
            echo "Root-owned files found:"; cat root_owned.txt || true
            echo "Stat for affected files:"; while read -r f; do stat -c "File: %n\nOwner: %U:%G\nPerms: %A (%a)\nSize: %s\nModTime: %y\n" "$f" || true; done < root_owned.txt > root_owned_stat.txt || true
            lsattr -R $(cat root_owned.txt 2>/dev/null) 2>/dev/null || true
            # Also show any open fds
            sudo -n lsof +D $(cat root_owned.txt 2>/dev/null) 2>/dev/null || lsof +D $(cat root_owned.txt 2>/dev/null) 2>/dev/null || true
            sudo -n fuser -v $(cat root_owned.txt 2>/dev/null) 2>/dev/null || fuser -v $(cat root_owned.txt 2>/dev/null) 2>/dev/null || true
            echo "Root-owned precheck failed: root-owned files present"
            exit 1
          else
            echo "No root-owned files found (pre-check passed)"
          fi

      - name: Upload diagnostic artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: root-owned-precheck
          path: |
            debug_workspace_root_precheck.txt
            root_owned.txt
            root_owned_stat.txt
