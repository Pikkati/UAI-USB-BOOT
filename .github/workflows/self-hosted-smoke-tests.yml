name: Self-Hosted Runner Smoke Tests

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *' # daily at 03:00 UTC (run on self-hosted)

permissions:
  contents: read
  actions: read

jobs:
  smoke:
    runs-on: [self-hosted, docker-swarm]
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Prepare environment
        run: |
          sudo apt-get update -y && sudo apt-get install -y jq npm curl || true

      - name: Run self-hosted smoke tests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          bash ci/self_hosted_smoke_tests.sh

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@ff15f0306b3f739f7b6fd43fb5d26cd321bd4de5
        with:
          name: smoke-test-results
          path: smoke_test_results.json
