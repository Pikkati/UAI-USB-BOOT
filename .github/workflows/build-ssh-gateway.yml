name: Build & Smoke-test ssh-gateway

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 15
      threshold_percent: 5
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
  build-and-smoke:
    needs: [credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f

      - name: Build ssh-gateway image
        run: |
          docker build -t uai/ssh-gateway:ci ./docker/ssh-gateway

      - name: Run ssh-gateway container
        run: |
          docker run -d --name ssh-gateway-test -e SSH_KEY_SERVER_URL="" uai/ssh-gateway:ci

      - name: Wait for sshd to start
        run: |
          for i in $(seq 1 30); do
            if docker exec ssh-gateway-test pgrep sshd >/dev/null 2>&1; then
              echo "sshd running"
              exit 0
            fi
            sleep 1
          done
          echo "sshd did not start; container logs:" && docker logs ssh-gateway-test
          exit 1

      - name: "Sanity check: sshd config"
        run: |
          docker exec ssh-gateway-test sshd -T | head -n 5

      - name: Cleanup
        if: always()
        run: |
          docker rm -f ssh-gateway-test || true
