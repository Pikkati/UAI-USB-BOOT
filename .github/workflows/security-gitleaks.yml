name: Security Gitleaks Scan
true:
  pull_request: null
  push:
    branches:
    - main
  schedule:
  - cron: 0 0 * * *
  workflow_dispatch: null
jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 10
      threshold_percent: 3
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'
      slack_webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
  scan:
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      with:
        fetch-depth: 0
    - name: Install gitleaks
      run: 'wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz

        tar -xzf gitleaks_8.18.0_linux_x64.tar.gz

        sudo mv gitleaks /usr/local/bin/

        '
    - name: Run gitleaks scan
      run: 'gitleaks detect --verbose --redact --report-format json --report-path
        gitleaks-report.json

        '
      continue-on-error: true
    - name: Parse report with Python script
      run: "if [ \"${{ github.event_name }}\" == \"pull_request\" ]; then\n  python\
        \ SECURITY/history-purge/process_gitleaks_report.py --input gitleaks-report.json\
        \ --output-dir issues --dry-run\nelse\n  python SECURITY/history-purge/process_gitleaks_report.py\
        \ --input gitleaks-report.json --output-dir issues\nfi\n"
    - name: Create GitHub issues (push/schedule only)
      if: github.event_name == 'push' || github.event_name == 'schedule' || github.event_name
        == 'workflow_dispatch'
      run: 'python SECURITY/history-purge/scripts/create_gh_issues.py

        '
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload artifacts
      uses: actions/upload-artifact@ff15f0306b3f739f7b6fd43fb5d26cd321bd4de5
      with:
        name: gitleaks-report
        path: gitleaks-report.json
    needs:
    - credit_check
