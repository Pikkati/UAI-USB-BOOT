name: Run tests

on:
  push:
  pull_request:

jobs:
  credit_check:
    uses: ./.github/workflows/actions-credit-guard-enhanced.yml
    with:
      estimated_minutes: 15
      threshold_percent: 3
      force_local: true
      fallback_runner: '["self-hosted","docker-swarm"]'

  root-owned-precheck:
    needs: [credit_check]
    uses: ./.github/workflows/root-owned-precheck.yml
    with:
      runner: ${{ needs.credit_check.outputs.runner }}

  quality:
    needs: [credit_check]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
    - name: Checkout
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
    - name: Set up Python
      uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
      with:
        python-version: 3.11
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
    - name: Run pre-commit
      run: pre-commit run --all-files --show-diff-on-failure

  test:
    needs: [credit_check, quality]
    runs-on: ${{ fromJson(needs.credit_check.outputs.runner) }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Set up Python
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
        with:
          python-version: 3.11
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      - name: Run tests
        run: |
          pytest -q
