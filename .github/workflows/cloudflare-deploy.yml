name: Deploy Cloudflare Worker

on:
  push:
    paths:
      - 'workers/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, docker-swarm]
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Verify Cloudflare token
        run: |
          echo "Verifying Cloudflare token..."
          sudo apt-get update -y && sudo apt-get install -y jq curl
          resp=$(curl -sS -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" "https://api.cloudflare.com/client/v4/user/tokens/verify")
          echo "$resp" | jq -r '.messages[]?.message' || true
          ok=$(echo "$resp" | jq -r '.success')
          if [ "$ok" != "true" ]; then
            echo "Cloudflare token verification failed. Please create a token with scopes: Account:Read, User Details:Read, Workers Scripts:Write, Workers Routes:Write, AI:Write and save it as CLOUDFLARE_API_TOKEN."
            exit 1
          fi

      - name: Install Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Wrangler whoami
        run: wrangler whoami --cwd workers

      - name: Check Wrangler token permissions
        run: |
          out=$(wrangler whoami --cwd workers 2>&1 || true)
          echo "$out"
          if echo "$out" | grep -q "Unable to retrieve email"; then
            echo "::error::Cloudflare API token is missing the 'User Details:Read' permission. Please recreate a token with scopes: Account:Read, User Details:Read, Workers Scripts:Write, Workers Routes:Write, AI:Write and save it as CLOUDFLARE_API_TOKEN in repository secrets."
            exit 1
          fi

      - name: Show worker files
        run: ls -la workers || true

      - name: Deploy Worker
        run: wrangler deploy --cwd workers --env production
