name: Deploy to Netlify (production)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, docker-swarm]
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: '20'

      - name: Install Netlify CLI
        run: npm install -g netlify-cli

      - name: Verify Netlify token and site access
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          echo "Verifying Netlify token and site access..."
          sudo apt-get update -y && sudo apt-get install -y jq curl
          if [ -z "$NETLIFY_AUTH_TOKEN" ]; then
            echo "::error::NETLIFY_AUTH_TOKEN is not set. Create a Netlify Personal Access Token (with deploy permissions) and save it as NETLIFY_AUTH_TOKEN in repository secrets."
            exit 1
          fi
          resp=$(curl -sS -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" "https://api.netlify.com/api/v1/user")
          id=$(echo "$resp" | jq -r '.id // empty')
          if [ -z "$id" ]; then
            echo "::error::NETLIFY_AUTH_TOKEN is invalid or expired. Create a valid Personal Access Token and save it as NETLIFY_AUTH_TOKEN."
            echo "Response: $resp"
            exit 1
          fi
          if [ -z "$NETLIFY_SITE_ID" ]; then
            echo "::error::NETLIFY_SITE_ID is not set. Please set NETLIFY_SITE_ID in repo secrets to the target site's id."
            exit 1
          fi
          site_resp=$(curl -sS -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" "https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID")
          if echo "$site_resp" | jq -e '.id' > /dev/null 2>&1; then
            echo "Token can access site $NETLIFY_SITE_ID."
          else
            if echo "$site_resp" | grep -iq "Forbidden"; then
              echo "::error::NETLIFY_AUTH_TOKEN does not have access to site $NETLIFY_SITE_ID. Ensure the token belongs to a user with permissions to deploy to this site or create a team token with proper access."
            else
              echo "::error::Could not access site $NETLIFY_SITE_ID. Response: $site_resp"
            fi
            exit 1
          fi

      - name: Deploy to Netlify
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          echo "Deploying to Netlify..."
          netlify deploy --prod --dir=public --site=$NETLIFY_SITE_ID
